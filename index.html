<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test auth</title>
  </head>
  <body>
    <script>
      const register = async (options) => {
        const data = await fetch("http://localhost:3000/users", options);
        const result = await data.json();
        console.log(result);
      };

      const login = async (options) => {
        const data = await fetch(
          "http://localhost:3000/users/sign_in",
          options
        );
        const result = await data.json();
        console.log(result);
        return data;
      };

      const loginWithToken = async (headers) => {
        const data = await fetch("http://localhost:3000/posts", {
          headers,
          method: "GET",
        });
        const result = await data.json();
        console.log(result);
      };

      const postWithToken = async (headers) => {
        const data = await fetch("http://localhost:3000/posts", {
          headers,
          method: "POST",
          body: JSON.stringify({
            post: {
              title: `${Math.random()} iÃ¨me post`,
              content: "contenu du post",
            },
          }),
        });
        const result = await data.json();
        console.log(result);
      };

      const logout = async (headers) => {
        const data = await fetch("http://localhost:3000/users/sign_out", {
          headers,
          method: "DELETE",
        });
        const result = await data.json();
        console.log(result);
      };

      const main = async () => {
        const headers = new Headers();

        headers.append("Content-Type", "application/json");

        const options = {
          headers,
          method: "POST",
          body: JSON.stringify({
            user: {
              email: `test@${Math.random()}.fr`,
              password: "azerty",
            },
          }),
        };

        await register(options);

        const data = await login(options);
        headers.append("Authorization", data.headers.get("Authorization"));
        // console.log(data.headers.get("Authorization"))
        await loginWithToken(headers);
        await postWithToken(headers);
        await logout(headers);
        // await register1(options1);
      };

      main();
    </script>
  </body>
</html>
